from django.shortcuts import render, get_list_or_404, get_object_or_404
from django.template import loader
from django.http import HttpResponse
# Create your views here.
from .models import Blog
from django.contrib.postgres.aggregates import StringAgg
from django.db import connection
import json


def index(request, blog_id):
    content = request.GET.get('content')
    if content == None:
        content = ''

    #payload = '-\') AS "mydefinedname" FROM "vul_blog" WHERE 1=1 AND case when (SELECT length(string_agg(vul_flag.flag, \'\')) FROM vul_flag) > 9 then true else false end GROUP BY "vul_blog"."title" LIMIT 1 offset 1 -- '
    payload = content
    results = Blog.objects.all().filter(pk=blog_id).values('title').annotate(
        mydefinedname=StringAgg('content', delimiter=payload))

    convert = []
    for row in results:
        convert.append(row)
    context = {'posts': convert}

    return render(request, 'vul/index.html', context)
